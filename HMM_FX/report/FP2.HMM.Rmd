---
title: "Computational Finance (Part II): Assessing the Effectiveness of HMM in Algorithmic Trading Series"
output:
  html_document: default
  pdf_document: default
date: "2025-06-30"
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(
  echo = FALSE, message = FALSE, warning = FALSE, include = FALSE,# output
  fig.width = 10, fig.height = 6, dpi = 150, fig.align = "center" # figures
)

```

```{r packages}

LoadLibraries <- function() {
  require(tidyverse) # general
  require(lubridate) # periods, date, etc...
  require(TTR) # Technical indicators such as ATR, EMA, ADX, VHF, DonchianChannel
  require(mhsmm) # Hidden Markov Models, Semi-HMM
  require(mstudentd) # dmtd() used in mtdist.hsmm()
  require(gamlss) # fitdist()
  require(zoo) # rollapply()
  require(tseries) # rolling mean
  require(PerformanceAnalytics) # indicators 
  require(patchwork) # plots
}

LoadLibraries()

```

```{r objects}

load("objects_Rmd")

```

```{r}

head(FX, 10)

```

``` {r fig.cap = "Figure 1. qq-plot of Currency Pairs", out.width="100%", include=TRUE, fig.width=16, fig.height=10}


returns <- diff(log(FX))[-1, ]

par(mfrow = c(2, 2))

# EURCAD
qqnorm(returns[, "EURCAD"], main = "Q-Q Plot: EURCAD", col = "steelblue")
qqline(returns[, "EURCAD"], col = "red")

# EURGBP
qqnorm(returns[, "EURGBP"], main = "Q-Q Plot: EURGBP", col = "steelblue")
qqline(returns[, "EURGBP"], col = "red")

# EURJPY
qqnorm(returns[, "EURJPY"], main = "Q-Q Plot: EURJPY", col = "steelblue")
qqline(returns[, "EURJPY"], col = "red")

# EURUSD
qqnorm(returns[, "EURUSD"], main = "Q-Q Plot: EURUSD", col = "steelblue")
qqline(returns[, "EURUSD"], col = "red")

par(mfrow = c(1, 1))

```

``` {r, include=TRUE}

print(summary.statistics)

```

``` {r, include=TRUE}

print(jb)

```

 `We decide to proceed with EURUSD and model a multivariate HMM using 5min intra-day bars`

1. **Returns** - standardized log returns
2. **ATR14** - Volatility indicator; rising ATR typically signals trend initiation.
3. **EMA20** - EMA slope; detects persistent directional price movement.
4. **ADX14** - Measures strenght of ongoing trend
5. **Aroon** - Oscillator showing time since recent highs and lows; useful for trend starts.
6. **VHF28** - Ratio between vertical and horizontal price movement; the higher the value the stronger the trend
7. **DonchianWidth20** - Bandwith between recent highs and recent lows; expansion implies trend
 
```{r, include=TRUE, rownames.print= FALSE}

print(features.table)

```

``` {r fig.cap = "Figure 2. qq-plots for Standardized Indicators", out.width="100%", include=TRUE, fig.width=16, fig.height=10}


x <- as.matrix(features)

# Quick sanity check
par(mfrow = c(2, 4))

for (col in c("zReturns", "zATR14", "zEMA20.1bar", "zADX14", "zAroon", "zVHF28", "zDonchianWidth20")) {
  x <- df.opt.5min[[col]]
  qqnorm(x, main = paste("QQ Plot:", col), col = "blue")
  qqline(x, col = "red", lwd = 2)
}

par(mfrow=c(1,1))

```

### Emission Distribution = Student T

After inspecting the distribution of log returns and standardized indicators via Q-Q plots, I observed clear evidence of **non-normality**, particularly **fat tails**.

As a result, I chose to use the **Student-*t* distribution** for the emission densities in the HMM. This distribution is well-suited for capturing heavy tails, which are common in financial data.

Despite testing more flexible alternatives such as the **Generalized t** and **Skewed t** distributions, I decided against using them in the final model for the following reasons:

- **Computational cost**: With over **98,000 observations** and **7 variables**, these more complex distributions required significant memory and time to fit.
- **Reproducibility**: Student-*t* offered a strong balance between robustness and computational feasibility.

### Model Configurations

To evaluate the effect of state duration assumptions, I fitted the following models:

- **3 Sojourn Distributions**:
  - Gamma
  - Poisson (shift = 5)
  - Geometric (i.e., standard HMM)

- **3 Hidden States**:
  - K = 2, 3, 4

In total, this gives **9 unique model configurations** (3 sojourn types Ã— 3 values of K).

Each model was trained on the standardized multivariate time series using the **Student-*t* emission distribution** described previously.


``` {r fig.cap = "Figure 3. State Regimes for 3-state Gamma", out.width="100%", include=TRUE, fig.width=24, fig.height=10}


candleplot.gamma.K2 + candleplot.gamma.K3 + candleplot.gamma.K4 +
  plot_annotation(
    title = "Comparison of Hidden States for K = 2, 3, and 4 (Gamma SD)",
    theme = theme(plot.title = element_text(size = 16, face = "bold"))
  )

```

``` {r fig.cap = "Figure 4. State Regimes for 3-state Poisson", out.width="100%", include=TRUE, fig.width=24, fig.height=10}


candleplot.gamma.K3 + candleplot.geometric.K3 + candleplot.poisson.K3 +
  plot_annotation("Comparison of transition distributions at K = 3",
                  theme = theme(
                    plot.title = element_text(size = 16, face = "bold"))
                  )

```

### State Dynamics and Model Justification

To support our final model selection, we evaluated key properties of each fitted model:

- **State Visitation Frequencies**  
  How often each regime occurs.

- **Average Sojourn Durations**  
  How long the model expects to remain in each state.

- **Transition Matrix**  
  Shows how stable each state is, and how often transitions occur.

We show this below for the geometric model with 3 states, our final choice due to its clear regime separation and strong persistence behavior.

``` {r, include=TRUE}

print(summary.models)

```

``` {r, include=TRUE}

for (name in names(transitions)) {
  cat("\n---", name, "---\n")
  print(transitions[[name]])
}

```

## Trading Strategy

We implement a **pullback breakout mean-reversion strategy** on 5-minute EUR/USD data. This strategy aims to capture quick reversion to the mean after price breaks out from a multi-week high, retraces, and bounces back.

### Entry Logic
- **Breakout trigger:** Close outside of BB bounds.
- **Buy level:** 61.8% Fibonacci retracement of the breakout candle.
- **Filter:** Only trade long when price is above SMA(200) and short when price is below SMA(200).
- **HMM Filter:** Implement state separation to see whether it will improve performance.

### Exit Logic
- **Take Profit (TP):** Bracket 1: 20-period SMA (mean reversion target), Bracket 2: 1.5 * SMA(20) - entry, Bracket 3: 2 * SMA(20) - entry
- **Stop Loss (SL):** TP is set to 100 pips which will protect us against Black Swan events.

### Execution Details
- **Slippage:** 0.00 since we are only dealing with Limit Orders
- **Commission:** $3 per round-trip per 1.0 lot
- **Lot Size:** 100,000 (1.0 standard lot)

# Example trade

``` {r fig.cap = "Figure 5. Trade Setup Example in MT5", out.width="100%", include=TRUE, fig.width=14, fig.height=10}

knitr::include_graphics("MT5_trade_setup_example.png", error = F)

```

``` {r, include=TRUE}

print(performance.summary)

```

``` {r fig.cap = "Figure 5. Equity Curve of Different Trading Setups", out.width="100%", include=TRUE, fig.width=14, fig.height=10}

equity.curve

```








